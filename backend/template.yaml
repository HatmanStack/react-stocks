AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: React Stocks Backend - Lambda API for Tiingo and Finnhub proxying

Parameters:
  TiingoApiKey:
    Type: String
    Description: Tiingo API key for stock price data
    NoEcho: true

  FinnhubApiKey:
    Type: String
    Description: Finnhub API key for news data
    NoEcho: true

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: nodejs20.x
    Architectures:
      - x86_64
    Environment:
      Variables:
        NODE_ENV: production
        LOG_LEVEL: INFO
    Tracing: Active  # Enable X-Ray tracing for debugging

Resources:
  ReactStocksApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        # CORS Configuration - Currently allows all origins for demo/development
        # Security Note: '*' allows any domain to access this API
        # For production with known frontend domains, replace with specific origins:
        # AllowOrigins:
        #   - 'https://your-production-domain.com'
        #   - 'https://your-staging-domain.com'
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - Authorization
        MaxAge: 300

  ReactStocksFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: dist/index.handler
      Description: Backend proxy for Tiingo and Finnhub APIs
      Environment:
        Variables:
          TIINGO_API_KEY: !Ref TiingoApiKey
          FINNHUB_API_KEY: !Ref FinnhubApiKey
      Events:
        StocksApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ReactStocksApi
            Path: /stocks
            Method: GET
        NewsApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ReactStocksApi
            Path: /news
            Method: GET
        SearchApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ReactStocksApi
            Path: /search
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node20
        Sourcemap: false
        EntryPoints:
          - src/index.ts
        External:
          - aws-sdk

Outputs:
  ReactStocksApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${ReactStocksApi}.execute-api.${AWS::Region}.amazonaws.com'
    Export:
      Name: !Sub '${AWS::StackName}-ApiUrl'

  ReactStocksFunctionArn:
    Description: Lambda Function ARN
    Value: !GetAtt ReactStocksFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-FunctionArn'

  ReactStocksFunctionIamRole:
    Description: IAM Role for Lambda Function
    Value: !GetAtt ReactStocksFunctionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-FunctionRole'
